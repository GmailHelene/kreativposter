import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';

/**
 * TestDashboard - Komponent for å teste browser-kompatibilitet og systemkrav
 * Brukes til å verifisere at alle nødvendige funksjoner støttes av nettleseren
 */
const TestDashboard = () => {
  // State for testresultater
  const [testResults, setTestResults] = useState({});
  const [overallStatus, setOverallStatus] = useState('running');
  const [isTesting, setIsTesting] = useState(true);
  
  // Kjør tester ved lasting av komponenten
  useEffect(() => {
    runAllTests();
  }, []);
  
  // Kjør alle tester
  const runAllTests = async () => {
    setIsTesting(true);
    setOverallStatus('running');
    
    const tests = {
      localStorage: testLocalStorage(),
      indexedDB: await testIndexedDB(),
      webWorkers: testWebWorkers(),
      serviceWorkers: await testServiceWorkers(),
      webShare: testWebShare(),
      mediaCapture: testMediaCapture(),
      notifications: await testNotifications(),
      geolocation: testGeolocation(),
      fileAccess: testFileAccess(),
      copyPaste: testClipboard(),
      fullscreen: testFullscreen(),
      webp: await testWebPSupport(),
      performance: testPerformance()
    };
    
    // Oppdater testresultater
    setTestResults(tests);
    
    // Sjekk samlet status
    const results = Object.values(tests);
    if (results.some(r => r.status === 'critical')) {
      setOverallStatus('critical');
    } else if (results.some(r => r.status === 'warning')) {
      setOverallStatus('warning');
    } else {
      setOverallStatus('success');
    }
    
    setIsTesting(false);
  };
  
  // Test localStorage
  const testLocalStorage = () => {
    try {
      localStorage.setItem('testItem', 'test');
      const value = localStorage.getItem('testItem');
      localStorage.removeItem('testItem');
      
      if (value === 'test') {
        return {
          name: 'Local Storage',
          status: 'success',
          message: 'Local Storage støttes og fungerer'
        };
      } else {
        return {
          name: 'Local Storage',
          status: 'critical',
          message: 'Local Storage fungerer ikke korrekt'
        };
      }
    } catch (error) {
      return {
        name: 'Local Storage',
        status: 'critical',
        message: 'Local Storage støttes ikke: ' + error.message
      };
    }
  };
  
  // Test IndexedDB
  const testIndexedDB = async () => {
    return new Promise(resolve => {
      try {
        const request = window.indexedDB.open('testDB', 1);
        
        request.onerror = () => {
          resolve({
            name: 'IndexedDB',
            status: 'critical',
            message: 'IndexedDB støttes ikke eller er deaktivert'
          });
        };
        
        request.onsuccess = event => {
          const db = event.target.result;
          db.close();
          
          // Forsøk å slette testdatabasen
          try {
            window.indexedDB.deleteDatabase('testDB');
          } catch (e) {
            console.error('Kunne ikke slette test-database:', e);
          }
          
          resolve({
            name: 'IndexedDB',
            status: 'success',
            message: 'IndexedDB støttes og fungerer'
          });
        };
        
        request.onupgradeneeded = event => {
          const db = event.target.result;
          const objectStore = db.createObjectStore('testStore', { keyPath: 'id' });
          objectStore.add({ id: 1, value: 'test' });
        };
      } catch (error) {
        resolve({
          name: 'IndexedDB',
          status: 'critical',
          message: 'IndexedDB støttes ikke: ' + error.message
        });
      }
    });
  };
  
  // Test Web Workers
  const testWebWorkers = () => {
    if (typeof Worker !== 'undefined') {
      try {
        // Opprett en blob URL for worker
        const workerBlob = new Blob([
          `self.onmessage = function(e) { 
            self.postMessage('success'); 
            self.close(); 
          }`
        ], { type: 'application/javascript' });
        
        const workerUrl = URL.createObjectURL(workerBlob);
        const worker = new Worker(workerUrl);
        
        worker.terminate();
        URL.revokeObjectURL(workerUrl);
        
        return {
          name: 'Web Workers',
          status: 'success',
          message: 'Web Workers støttes'
        };
      } catch (error) {
        return {
          name: 'Web Workers',
          status: 'warning',
          message: 'Web Workers støttes men kunne ikke startes: ' + error.message
        };
      }
    } else {
      return {
        name: 'Web Workers',
        status: 'warning',
        message: 'Web Workers støttes ikke'
      };
    }
  };
  
  // Test Service Workers
  const testServiceWorkers = async () => {
    if ('serviceWorker' in navigator) {
      try {
        return {
          name: 'Service Workers',
          status: 'success',
          message: 'Service Workers støttes'
        };
      } catch (error) {
        return {
          name: 'Service Workers',
          status: 'warning',
          message: 'Service Workers støttes men kunne ikke registreres: ' + error.message
        };
      }
    } else {
      return {
        name: 'Service Workers',
        status: 'warning',
        message: 'Service Workers støttes ikke'
      };
    }
  };
  
  // Test Web Share API
  const testWebShare = () => {
    if (navigator.share) {
      return {
        name: 'Web Share API',
        status: 'success',
        message: 'Web Share API støttes'
      };
    } else {
      return {
        name: 'Web Share API',
        status: 'warning',
        message: 'Web Share API støttes ikke, delefunksjonalitet vil være begrenset'
      };
    }
  };
  
  // Test Media Capture API
  const testMediaCapture = () => {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      return {
        name: 'Media Capture',
        status: 'success',
        message: 'Media Capture API støttes'
      };
    } else {
      return {
        name: 'Media Capture',
        status: 'warning',
        message: 'Media Capture API støttes ikke, direkte opplasting av kamera/mikrofon vil ikke fungere'
      };
    }
  };
  
  // Test Notifications API
  const testNotifications = async () => {
    if ('Notification' in window) {
      let permission = Notification.permission;
      
      if (permission === 'granted') {
        return {
          name: 'Notifications',
          status: 'success',
          message: 'Notifications API støttes og tillatelse er gitt'
        };
      } else if (permission === 'denied') {
        return {
          name: 'Notifications',
          status: 'warning',
          message: 'Notifications API støttes men tillatelse er avslått'
        };
      } else {
        return {
          name: 'Notifications',
          status: 'warning',
          message: 'Notifications API støttes men tillatelse er ikke avgjort'
        };
      }
    } else {
      return {
        name: 'Notifications',
        status: 'warning',
        message: 'Notifications API støttes ikke'
      };
    }
  };
  
  // Test Geolocation API
  const testGeolocation = () => {
    if ('geolocation' in navigator) {
      return {
        name: 'Geolocation',
        status: 'success',
        message: 'Geolocation API støttes'
      };
    } else {
      return {
        name: 'Geolocation',
        status: 'warning',
        message: 'Geolocation API støttes ikke'
      };
    }
  };
  
  // Test File API
  const testFileAccess = () => {
    if (window.File && window.FileReader && window.FileList && window.Blob) {
      return {
        name: 'File Access',
        status: 'success',
        message: 'File APIs støttes'
      };
    } else {
      return {
        name: 'File Access',
        status: 'critical',
        message: 'File APIs støttes ikke, filhåndtering vil ikke fungere'
      };
    }
  };
  
  // Test Clipboard API
  const testClipboard = () => {
    if (navigator.clipboard) {
      return {
        name: 'Clipboard',
        status: 'success',
        message: 'Clipboard API støttes'
      };
    } else {
      return {
        name: 'Clipboard',
        status: 'warning',
        message: 'Clipboard API støttes ikke, kopier/lim inn vil være begrenset'
      };
    }
  };
  
  // Test Fullscreen API
  const testFullscreen = () => {
    if (document.documentElement.requestFullscreen) {
      return {
        name: 'Fullscreen',
        status: 'success',
        message: 'Fullscreen API støttes'
      };
    } else {
      return {
        name: 'Fullscreen',
        status: 'warning',
        message: 'Fullscreen API støttes ikke'
      };
    }
  };
  
  // Test WebP support
  const testWebPSupport = async () => {
    return new Promise(resolve => {
      const webP = new Image();
      webP.src = 'data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vuUAAA=';
      
      webP.onload = function() {
        const result = (webP.width > 0) && (webP.height > 0);
        resolve({
          name: 'WebP Support',
          status: result ? 'success' : 'warning',
          message: result ? 'WebP bildestøtte finnes' : 'WebP bildestøtte mangler, bilder vil vises i eldre format'
        });
      };
      
      webP.onerror = function() {
        resolve({
          name: 'WebP Support',
          status: 'warning',
          message: 'WebP bildestøtte mangler, bilder vil vises i eldre format'
        });
      };
    });
  };
  
  // Test Performance API
  const testPerformance = () => {
    if (window.performance) {
      return {
        name: 'Performance API',
        status: 'success',
        message: 'Performance API støttes'
      };
    } else {
      return {
        name: 'Performance API',
        status: 'warning',
        message: 'Performance API støttes ikke, ytelsesovervåking vil ikke fungere'
      };
    }
  };
  
  // Vis testresultater etter status
  const renderTestResults = (status) => {
    const filteredTests = Object.values(testResults).filter(test => test.status === status);
    
    if (filteredTests.length === 0) {
      return null;
    }
    
    return (
      <div className={`mb-6 p-4 rounded-lg border ${
        status === 'success' ? 'bg-green-50 border-green-200' :
        status === 'warning' ? 'bg-yellow-50 border-yellow-200' :
        'bg-red-50 border-red-200'
      }`}>
        <h3 className={`text-lg font-bold mb-2 ${
          status === 'success' ? 'text-green-700' :
          status === 'warning' ? 'text-yellow-700' :
          'text-red-700'
        }`}>
          {status === 'success' ? 'Bestått' :
           status === 'warning' ? 'Advarsler' :
           'Kritiske feil'}
        </h3>
        
        <ul className="space-y-2">
          {filteredTests.map((test, index) => (
            <li key={index} className="flex items-start">
              <span className={`flex-shrink-0 h-5 w-5 rounded-full flex items-center justify-center mr-2 ${
                status === 'success' ? 'bg-green-100 text-green-600' :
                status === 'warning' ? 'bg-yellow-100 text-yellow-600' :
                'bg-red-100 text-red-600'
              }`}>
                {status === 'success' ? '✓' :
                 status === 'warning' ? '!' :
                 '✕'}
              </span>
              <div>
                <div className="font-medium">{test.name}</div>
                <div className="text-sm text-gray-600">{test.message}</div>
              </div>
            </li>
          ))}
        </ul>
      </div>
    );
  };
  
  // Beregn kompatibilitetsscore
  const calculateCompatibilityScore = () => {
    const tests = Object.values(testResults);
    if (tests.length === 0) return 0;
    
    const maxScore = tests.length * 3;
    let score = 0;
    
    tests.forEach(test => {
      if (test.status === 'success') score += 3;
      else if (test.status === 'warning') score += 1;
    });
    
    return Math.round((score / maxScore) * 100);
  };
  
  return (
    <div className="min-h-screen bg-gray-100">
      <div className="max-w-4xl mx-auto p-4">
        <div className="flex items-center mb-6">
          <Link to="/" className="text-blue-600 hover:text-blue-800">
            <i className="fas fa-arrow-left mr-2"></i>
            Tilbake til dashbord
          </Link>
        </div>
        
        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-2xl font-bold text-gray-800">System Test Dashboard</h1>
            
            <button
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
              onClick={runAllTests}
              disabled={isTesting}
            >
              {isTesting ? (
                <>
                  <span className="inline-block animate-spin mr-2">↻</span>
                  Tester...
                </>
              ) : (
                'Kjør alle tester'
              )}
            </button>
          </div>
          
          {Object.keys(testResults).length > 0 && (
            <>
              <div className="mb-6">
                <div className="flex items-center justify-between">
                  <h2 className="text-lg font-bold text-gray-800">Kompatibilitet</h2>
                  <div className="text-2xl font-bold">
                    {calculateCompatibilityScore()}%
                  </div>
                </div>
                
                <div className="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                  <div 
                    className={`h-2.5 rounded-full ${
                      overallStatus === 'success' ? 'bg-green-600' :
                      overallStatus === 'warning' ? 'bg-yellow-600' :
                      'bg-red-600'
                    }`}
                    style={{ width: `${calculateCompatibilityScore()}%` }}
                  ></div>
                </div>
                
                <div className="mt-2 text-sm text-gray-600">
                  {overallStatus === 'success' ? 
                    'Systemet støtter alle nødvendige funksjoner for optimal ytelse.' :
                    overallStatus === 'warning' ?
                    'Systemet har noen begrensninger, men alle kritiske funksjoner støttes.' :
                    'Systemet mangler viktige funksjoner som kan påvirke brukeropplevelsen betydelig.'
                  }
                </div>
              </div>
              
              <div>
                {renderTestResults('critical')}
                {renderTestResults('warning')}
                {renderTestResults('success')}
              </div>
              
              <div className="mt-6 text-sm text-gray-500">
                <p>
                  <strong>Merk:</strong> Disse testene sjekker bare om nettleseren din støtter de nødvendige
                  funksjonene. Andre faktorer som nettverkstilkobling, enhetsytelse og tilgjengelig lagringsplass
                  kan også påvirke applikasjonens ytelse.
                </p>
              </div>
            </>
          )}
        </div>
        
        <div className="bg-white rounded-lg shadow-sm p-6">
          <h2 className="text-lg font-bold text-gray-800 mb-3">Nettleserinformasjon</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <div className="font-medium">Nettleser</div>
              <div className="text-gray-600">{navigator.userAgent}</div>
            </div>
            
            <div>
              <div className="font-medium">Plattform</div>
              <div className="text-gray-600">{navigator.platform}</div>
            </div>
            
            <div>
              <div className="font-medium">Cookies aktivert</div>
              <div className="text-gray-600">{navigator.cookieEnabled ? 'Ja' : 'Nei'}</div>
            </div>
            
            <div>
              <div className="font-medium">Språk</div>
              <div className="text-gray-600">{navigator.language}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default TestDashboard;
